
***********************************************************************************
*** SETUP
***********************************************************************************

clear all
set more off
cap log close
set trace off
pause on
capture postutil close

cd ..
cd ..
global flint "`c(pwd)'"
	
***************************************************************************
* PREP EVER NOT FLINT VARIABLE
***************************************************************************

use "${flint}\data\student_level_all_2014.dta", clear

***restrict years
keep if inrange(year,2006,2019)

***restrict only to students lived in Flint (at some point)
gen flint = residentlea_weight==25010
egen tot_flint = total(flint), by(ric)
keep if tot_flint!=0 & tot_flint!=.

gen not_flint = abs(flint-1)
egen tot_not_flint = total(not_flint), by(ric)
gen ever_not_flint = tot_not_flint!=0 & tot_not_flint!=.

keep ric ever_not_flint
duplicates drop

tempfile notflint
save `notflint', replace

***************************************************************************
* PREP LEAD DATA
***************************************************************************

use "${flint}/data/matched_pipes_clean.dta", clear  

keep ric lead1 lead2 lead3 
duplicates drop

tempfile lead
save `lead', replace

***************************************************************************
* LOAD 55 student-level
***************************************************************************

use "${flint}\data\student_level_nonfixed_55districts.dta", clear

***************************************************************************
* Create SES measure
***************************************************************************

***restrict only to students lived in Flint (at some point)
gen flint = residentlea_weight==25010
egen tot_flint = total(flint), by(ric)
keep if tot_flint!=0 & tot_flint!=.

** Previously, SES generated by using a combination of variables: ppor, snap, tanf
** These variables are no longer available in the datasets maintained by MEDC
** Instead, use the newer "poor" variable, which already combines much of the same information 
/*
foreach var in snap tanf poor {
	egen mn_`var' = mean(`var'), by(ric)
	egen tot_`var' = total(`var'), by(ric)
}

egen max_year = max(year), by(ric)
keep if year==max_year

foreach var in snap tanf poor {
	areg mn_`var', absorb(grade_fnl)
	predict res_mn_`var', res
	sum res_mn_`var'
	replace res_mn_`var' = `r(mean)' if res_mn_`var'==.	
}

pca res_mn*
predict ses_pc, score
corr ses_pc poor snap tanf
mdesc ses_pc
*/
egen mn_poor = mean(poor), by(ric)
egen tot_poor = total(poor), by(ric)

egen max_year = max(year), by(ric)
keep if year==max_year

areg mn_poor, absorb(grade_fnl)
predict res_mn_poor, res
sum res_mn_poor
replace res_mn_poor = `r(mean)' if res_mn_poor==.	

rename res_mn_poor ses_pc

centile ses_pc, centile(33 67)
xtile ses_pc_qtile3 = ses_pc, nq(3)

centile ses_pc, centile(50)
xtile ses_pc_qtile2 = ses_pc, nq(2)

keep ric ses_pc_qtile2
duplicates drop

tempfile ses
save `ses', replace

***************************************************************************
* MERGE EVERYTHING TOGETHER
***************************************************************************

use "${flint}\data\student_level_nonfixed_55districts.dta", clear

keep if residentlea_weight==25010

keep if inrange(year,2006,2019)

merge m:1 ric using `notflint'
keep if _merge==1 | _merge==3
drop _merge

merge m:1 ric using `lead'
keep if _merge==1 | _merge==3
generate has_pipes_data = _merge==3
drop _merge

merge m:1 ric using `ses'
keep if _merge==1 | _merge==3
drop _merge

***********************************************************************************
*PIPES
***********************************************************************************
***********************************************************************************

preserve

gen flag_resdcode = 0 if (!missing(residentlea_weight) & !missing(dcode_weight))
replace flag_resdcode = 1 if residentlea_weight == dcode_weight & (!missing(residentlea_weight) & !missing(dcode_weight))

***gen observation count variables
gen obs=1
gen obs_ach=mean_ach !=.
gen obs_read=literacy !=.
gen obs_math=numeracy !=.
gen obs_attd=frac_attend3 !=.
gen obs_sped=speddummy !=.

*use has_assessment has_any_assessment count_3to8
gen frac_tested_trad = has_assessment/count_3to8
gen frac_tested_all = has_any_assessment/count_3to8


***Setting the scores outside grades 3-8 to missing
foreach v of varlist mean_ach literacy numeracy { 
	replace `v' = . if (grade_fnl < 3 | grade_fnl > 8) & !missing(grade_fnl)
}

**Destring LEP
gen lep2 = lep == "Y" if !missing(lep)
drop lep
rename lep2 lep

***collapse student level data to geodist-by-year
collapse (rawsum) obs* (firstnm) sample_55 sample_27 (mean) frac_tested_trad frac_tested_all flag_resdcode charter female white black hisp poor speddummy lep samebcode_prioryear samedcode_prioryear samelea_prioryear mean_ach literacy numeracy frac_attend3 frac_attend3_new suspended chronic_abs, by(residentlea_weight lead1 year) 

***do any observations that have less than 15 children by residentlea_weight grade_fnl year
drop if obs < 15
drop if missing(lead1)

***label new variables

label variable frac_tested_trad "fraction tested (traditionally tested/count grades 3 to 8)"
label variable frac_tested_all "fraction tested (all tested/count grades 3 to 8)"
label variable obs "Number of Observations"
label variable obs_ach "Number of Observations w/Achievement"
label variable obs_read "Number of Observations w/Reading"
label variable obs_math "Number of Observations w/Math"
label variable obs_attd "Number of Observations w/Attendance"
label variable obs_sped "Number of Observations w/Sped"
label variable year "Year"
label variable residentlea_weight "Residential LEA"
label variable flag_resdcode "Proportion of students with same dcode and same residentlea"
label variable charter "Charter"
label variable female "Female"
label variable white  "White"
label variable black "Black"
label variable hisp "Hispanic"
label variable poor "Economically disadvantaged"
label variable speddummy "Recieved Special Education"
label variable lep "Limited English Proficient"
label variable samebcode_prioryear  "Same school the prior year"
label variable samedcode_prioryear "Same district the prior year"
label variable samelea_prioryear "Same lea the prior year"
label variable mean_ach "Mean achievement - Readign + Math"
label variable literacy "Reading"
label variable numeracy "Math"
label variable frac_attend3 "Attendance"
label variable frac_attend3_new "Attendance fixed"
label variable chronic_abs "Chronic absenteeism (>= 10%)"
label variable suspended "Suspension"
label variable sample_55 "Part of the 55 districts (incuding flint)"
label variable sample_27 "Part of the 27 districts (including flint)"


***********************************************************************************
*************************************Step 3****************************************
*Save collapsed data (District, year, pipes)
***********************************************************************************
***********************************************************************************

save "${flint}\data\mi_geodist_panel_dypipes_nonfixed_55districts.dta", replace	
restore

***********************************************************************************
*EVER NOT FLINT
***********************************************************************************

preserve
gen flag_resdcode = 0 if (!missing(residentlea_weight) & !missing(dcode_weight))
replace flag_resdcode = 1 if residentlea_weight == dcode_weight & (!missing(residentlea_weight) & !missing(dcode_weight))

***gen observation count variables
gen obs=1
gen obs_ach=mean_ach !=.
gen obs_read=literacy !=.
gen obs_math=numeracy !=.
gen obs_attd=frac_attend3 !=.
gen obs_sped=speddummy !=.

*use has_assessment has_any_assessment count_3to8
gen frac_tested_trad = has_assessment/count_3to8
gen frac_tested_all = has_any_assessment/count_3to8


***Setting the scores outside grades 3-8 to missing
foreach v of varlist mean_ach literacy numeracy { 
	replace `v' = . if (grade_fnl < 3 | grade_fnl > 8) & !missing(grade_fnl)
}

**Destring LEP
gen lep2 = lep == "Y" if !missing(lep)
drop lep
rename lep2 lep

***collapse student level data to geodist-by-year
collapse (rawsum) obs* (firstnm) sample_55 sample_27 (mean) frac_tested_trad frac_tested_all flag_resdcode charter female white black hisp poor speddummy lep samebcode_prioryear samedcode_prioryear samelea_prioryear mean_ach literacy numeracy frac_attend3 frac_attend3_new suspended chronic_abs, by(residentlea_weight ever_not_flint year) 

***do any observations that have less than 15 children by residentlea_weight grade_fnl year
drop if obs < 15
drop if missing(ever_not_flint)

***label new variables

label variable frac_tested_trad "fraction tested (traditionally tested/count grades 3 to 8)"
label variable frac_tested_all "fraction tested (all tested/count grades 3 to 8)"
label variable obs "Number of Observations"
label variable obs_ach "Number of Observations w/Achievement"
label variable obs_read "Number of Observations w/Reading"
label variable obs_math "Number of Observations w/Math"
label variable obs_attd "Number of Observations w/Attendance"
label variable obs_sped "Number of Observations w/Sped"
label variable year "Year"
label variable residentlea_weight "Residential LEA"
label variable flag_resdcode "Proportion of students with same dcode and same residentlea"
label variable charter "Charter"
label variable female "Female"
label variable white  "White"
label variable black "Black"
label variable hisp "Hispanic"
label variable poor "Economically disadvantaged"
label variable speddummy "Recieved Special Education"
label variable lep "Limited English Proficient"
label variable samebcode_prioryear  "Same school the prior year"
label variable samedcode_prioryear "Same district the prior year"
label variable samelea_prioryear "Same lea the prior year"
label variable mean_ach "Mean achievement - Readign + Math"
label variable literacy "Reading"
label variable numeracy "Math"
label variable frac_attend3 "Attendance"
label variable frac_attend3_new "Attendance fixed"
label variable chronic_abs "Chronic absenteeism (>= 10%)"
label variable suspended "Suspension"
label variable sample_55 "Part of the 55 districts (incuding flint)"
label variable sample_27 "Part of the 27 districts (including flint)"

***********************************************************************************
*************************************Step 3****************************************
*Save collapsed data (District, year, ever not flint)
***********************************************************************************
***********************************************************************************

save "${flint}\data\mi_geodist_panel_dyevernf_nonfixed_55districts.dta", replace	
restore

***********************************************************************************
*SES
***********************************************************************************
***********************************************************************************

preserve
gen flag_resdcode = 0 if (!missing(residentlea_weight) & !missing(dcode_weight))
replace flag_resdcode = 1 if residentlea_weight == dcode_weight & (!missing(residentlea_weight) & !missing(dcode_weight))

***gen observation count variables
gen obs=1
gen obs_ach=mean_ach !=.
gen obs_read=literacy !=.
gen obs_math=numeracy !=.
gen obs_attd=frac_attend3 !=.
gen obs_sped=speddummy !=.

*use has_assessment has_any_assessment count_3to8
gen frac_tested_trad = has_assessment/count_3to8
gen frac_tested_all = has_any_assessment/count_3to8


***Setting the scores outside grades 3-8 to missing
foreach v of varlist mean_ach literacy numeracy { 
	replace `v' = . if (grade_fnl < 3 | grade_fnl > 8) & !missing(grade_fnl)
}

**Destring LEP
gen lep2 = lep == "Y" if !missing(lep)
drop lep
rename lep2 lep

***collapse student level data to geodist-by-year
collapse (rawsum) obs* (firstnm) sample_55 sample_27 (mean) frac_tested_trad frac_tested_all flag_resdcode charter female white black hisp poor speddummy lep samebcode_prioryear samedcode_prioryear samelea_prioryear mean_ach literacy numeracy frac_attend3 frac_attend3_new suspended chronic_abs, by(residentlea_weight ses_pc_qtile2 year) 

***do any observations that have less than 15 children by residentlea_weight grade_fnl year
drop if obs < 15
drop if missing(ses_pc_qtile2)

***label new variables

label variable frac_tested_trad "fraction tested (traditionally tested/count grades 3 to 8)"
label variable frac_tested_all "fraction tested (all tested/count grades 3 to 8)"
label variable obs "Number of Observations"
label variable obs_ach "Number of Observations w/Achievement"
label variable obs_read "Number of Observations w/Reading"
label variable obs_math "Number of Observations w/Math"
label variable obs_attd "Number of Observations w/Attendance"
label variable obs_sped "Number of Observations w/Sped"
label variable year "Year"
label variable residentlea_weight "Residential LEA"
label variable flag_resdcode "Proportion of students with same dcode and same residentlea"
label variable charter "Charter"
label variable female "Female"
label variable white  "White"
label variable black "Black"
label variable hisp "Hispanic"
label variable poor "Economically disadvantaged"
label variable speddummy "Recieved Special Education"
label variable lep "Limited English Proficient"
label variable samebcode_prioryear  "Same school the prior year"
label variable samedcode_prioryear "Same district the prior year"
label variable samelea_prioryear "Same lea the prior year"
label variable mean_ach "Mean achievement - Readign + Math"
label variable literacy "Reading"
label variable numeracy "Math"
label variable frac_attend3 "Attendance"
label variable frac_attend3_new "Attendance fixed"
label variable chronic_abs "Chronic absenteeism (>= 10%)"
label variable suspended "Suspension"
label variable sample_55 "Part of the 55 districts (incuding flint)"
label variable sample_27 "Part of the 27 districts (including flint)"

***********************************************************************************
*************************************Step 3****************************************
*Save collapsed data (District, year, ses)
***********************************************************************************
***********************************************************************************

save "${flint}\data\mi_geodist_panel_dyses2impute_nonfixed_55districts.dta", replace	
restore

***********************************************************************************
*Gender
***********************************************************************************
***********************************************************************************

preserve
gen flag_resdcode = 0 if (!missing(residentlea_weight) & !missing(dcode_weight))
replace flag_resdcode = 1 if residentlea_weight == dcode_weight & (!missing(residentlea_weight) & !missing(dcode_weight))

***gen observation count variables
gen obs=1
gen obs_ach=mean_ach !=.
gen obs_read=literacy !=.
gen obs_math=numeracy !=.
gen obs_attd=frac_attend3 !=.
gen obs_sped=speddummy !=.

*use has_assessment has_any_assessment count_3to8
gen frac_tested_trad = has_assessment/count_3to8
gen frac_tested_all = has_any_assessment/count_3to8


***Setting the scores outside grades 3-8 to missing
foreach v of varlist mean_ach literacy numeracy { 
	replace `v' = . if (grade_fnl < 3 | grade_fnl > 8) & !missing(grade_fnl)
}

**Destring LEP
gen lep2 = lep == "Y" if !missing(lep)
drop lep
rename lep2 lep

***collapse student level data to geodist-by-year
collapse (rawsum) obs* (firstnm) sample_55 sample_27 (mean) frac_tested_trad frac_tested_all flag_resdcode charter white black hisp poor speddummy lep samebcode_prioryear samedcode_prioryear samelea_prioryear mean_ach literacy numeracy frac_attend3 frac_attend3_new suspended chronic_abs, by(residentlea_weight female year) 

***do any observations that have less than 15 children by residentlea_weight grade_fnl year
drop if obs < 15
drop if missing(female)

***label new variables

label variable frac_tested_trad "fraction tested (traditionally tested/count grades 3 to 8)"
label variable frac_tested_all "fraction tested (all tested/count grades 3 to 8)"
label variable obs "Number of Observations"
label variable obs_ach "Number of Observations w/Achievement"
label variable obs_read "Number of Observations w/Reading"
label variable obs_math "Number of Observations w/Math"
label variable obs_attd "Number of Observations w/Attendance"
label variable obs_sped "Number of Observations w/Sped"
label variable year "Year"
label variable residentlea_weight "Residential LEA"
label variable flag_resdcode "Proportion of students with same dcode and same residentlea"
label variable charter "Charter"
label variable female "Female"
label variable white  "White"
label variable black "Black"
label variable hisp "Hispanic"
label variable poor "Economically disadvantaged"
label variable speddummy "Recieved Special Education"
label variable lep "Limited English Proficient"
label variable samebcode_prioryear  "Same school the prior year"
label variable samedcode_prioryear "Same district the prior year"
label variable samelea_prioryear "Same lea the prior year"
label variable mean_ach "Mean achievement - Readign + Math"
label variable literacy "Reading"
label variable numeracy "Math"
label variable frac_attend3 "Attendance"
label variable frac_attend3_new "Attendance fixed"
label variable chronic_abs "Chronic absenteeism (>= 10%)"
label variable suspended "Suspension"
label variable sample_55 "Part of the 55 districts (incuding flint)"
label variable sample_27 "Part of the 27 districts (including flint)"

***********************************************************************************
*************************************Step 3****************************************
*Save collapsed data (District, year, gender)
***********************************************************************************
***********************************************************************************

save "${flint}\data\mi_geodist_panel_dygender_nonfixed_55districts.dta", replace	

restore

***********************************************************************************
*Grade
***********************************************************************************
***********************************************************************************

preserve
gen flag_resdcode = 0 if (!missing(residentlea_weight) & !missing(dcode_weight))
replace flag_resdcode = 1 if residentlea_weight == dcode_weight & (!missing(residentlea_weight) & !missing(dcode_weight))

***gen observation count variables
gen obs=1
gen obs_ach=mean_ach !=.
gen obs_read=literacy !=.
gen obs_math=numeracy !=.
gen obs_attd=frac_attend3 !=.
gen obs_sped=speddummy !=.

**generate grade (<=5 vs. > 5)
generate grade_highlow = .
replace grade_highlow = 0 if grade_fnl <= 5 & !missing(grade_fnl)
replace grade_highlow = 1 if grade_fnl > 5 & !missing(grade_fnl)

label define grade_highlow 0 "K-5" 1 "6-12" 
label values grade_highlow grade_highlow 

*use has_assessment has_any_assessment count_3to8
gen frac_tested_trad = has_assessment/count_3to8
gen frac_tested_all = has_any_assessment/count_3to8


***Setting the scores outside grades 3-8 to missing
foreach v of varlist mean_ach literacy numeracy { 
	replace `v' = . if (grade_fnl < 3 | grade_fnl > 8) & !missing(grade_fnl)
}

**Destring LEP
gen lep2 = lep == "Y" if !missing(lep)
drop lep
rename lep2 lep

***collapse student level data to geodist-by-year
collapse (rawsum) obs* (firstnm) sample_55 sample_27 (mean) frac_tested_trad frac_tested_all flag_resdcode charter female white black hisp poor speddummy lep samebcode_prioryear samedcode_prioryear samelea_prioryear mean_ach literacy numeracy frac_attend3 frac_attend3_new suspended chronic_abs, by(residentlea_weight grade_highlow year) 

***do any observations that have less than 15 children by residentlea_weight grade_fnl year
drop if obs < 15
drop if missing(grade_highlow)

***label new variables

label variable frac_tested_trad "fraction tested (traditionally tested/count grades 3 to 8)"
label variable frac_tested_all "fraction tested (all tested/count grades 3 to 8)"
label variable obs "Number of Observations"
label variable obs_ach "Number of Observations w/Achievement"
label variable obs_read "Number of Observations w/Reading"
label variable obs_math "Number of Observations w/Math"
label variable obs_attd "Number of Observations w/Attendance"
label variable obs_sped "Number of Observations w/Sped"
label variable year "Year"
label variable residentlea_weight "Residential LEA"
label variable flag_resdcode "Proportion of students with same dcode and same residentlea"
label variable charter "Charter"
label variable female "Female"
label variable white  "White"
label variable black "Black"
label variable hisp "Hispanic"
label variable poor "Economically disadvantaged"
label variable speddummy "Recieved Special Education"
label variable lep "Limited English Proficient"
label variable samebcode_prioryear  "Same school the prior year"
label variable samedcode_prioryear "Same district the prior year"
label variable samelea_prioryear "Same lea the prior year"
label variable mean_ach "Mean achievement - Readign + Math"
label variable literacy "Reading"
label variable numeracy "Math"
label variable frac_attend3 "Attendance"
label variable frac_attend3_new "Attendance fixed"
label variable chronic_abs "Chronic absenteeism (>= 10%)"
label variable suspended "Suspension"
label variable sample_55 "Part of the 55 districts (incuding flint)"
label variable sample_27 "Part of the 27 districts (including flint)"

***********************************************************************************
*************************************Step 3****************************************
*Save collapsed data (District, year, grade)
***********************************************************************************
***********************************************************************************

save "${flint}\data\mi_geodist_panel_dygradehighlow_nonfixed_55districts.dta", replace	

restore
